{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"45651","self":"http://jira.codehaus.org/rest/api/latest/issue/45651","key":"PLXUTILS-25","fields":{"progress":{"progress":0,"total":0},"summary":"Runtime.addShutdownHook() prevents maven embedding","timetracking":{},"issuetype":{"self":"http://jira.codehaus.org/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"http://jira.codehaus.org/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"customfield_10110":null,"votes":{"self":"http://jira.codehaus.org/rest/api/2/issue/PLXUTILS-25/votes","votes":0,"hasVoted":false},"resolution":{"self":"http://jira.codehaus.org/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"fixVersions":[{"self":"http://jira.codehaus.org/rest/api/2/version/17364","id":"17364","description":"","name":"2.1","archived":false,"released":true,"releaseDate":"2011-06-09"}],"resolutiondate":"2011-05-16T12:33:54.091-0500","customfield_10210":"1.0","timespent":null,"reporter":{"self":"http://jira.codehaus.org/rest/api/2/user?username=mkleint","name":"mkleint","emailAddress":"mkleint@codehaus.org","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Milos Kleint","active":true},"aggregatetimeoriginalestimate":null,"customfield_10161":["igorfie(igorfie)","lacostej(lacostej)","krosenvold(krosenvold)","mkleint(mkleint)"],"customfield_10160":null,"updated":"2011-06-18T04:36:29.190-0500","created":"2007-01-05T04:01:17.204-0600","description":"\nwhile I haven't found an actual problem with the CommandLineUtils' use of shutdown hooks, I believe it's potencially dangerous for maven's execution in embedded environment.\n\nhttp://jira.codehaus.org/browse/MASSEMBLY-158 is related.\n\n\njava.lang.IllegalThreadStateException\n        at java.lang.ThreadGroup.add(ThreadGroup.java:856)\n        at java.lang.Thread.start(Thread.java:573)\n        at java.lang.Shutdown.runHooks(Shutdown.java:128)\n        at java.lang.Shutdown.sequence(Shutdown.java:173)\n        at java.lang.Shutdown.exit(Shutdown.java:218)\n        at java.lang.Runtime.exit(Runtime.java:90)\n        at java.lang.System.exit(System.java:869)\n        at org.netbeans.TopSecurityManager.exit(TopSecurityManager.java:128)\n        at org.netbeans.core.NbTopManager$3.run(NbTopManager.java:408)\n        at org.openide.util.Task.run(Task.java:222)\n        at org.openide.util.RequestProcessor$Task.run(RequestProcessor.java:541)\n[catch] at org.openide.util.RequestProcessor$Processor.run(RequestProcessor.java:963)\n","priority":{"self":"http://jira.codehaus.org/rest/api/2/priority/3","iconUrl":"http://jira.codehaus.org/images/icons/priorities/major.png","name":"Major","id":"3"},"duedate":null,"issuelinks":[{"id":"17514","self":"http://jira.codehaus.org/rest/api/2/issueLink/17514","type":{"id":"10010","name":"Related","inward":"is related to","outward":"relates to","self":"http://jira.codehaus.org/rest/api/2/issueLinkType/10010"},"outwardIssue":{"id":"43526","key":"MASSEMBLY-158","self":"http://jira.codehaus.org/rest/api/2/issue/43526","fields":{"summary":"tempRoot directory not created, exceptions thrown when filtering files","status":{"self":"http://jira.codehaus.org/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"http://jira.codehaus.org/images/icons/statuses/closed.png","name":"Closed","id":"6"},"priority":{"self":"http://jira.codehaus.org/rest/api/2/priority/1","iconUrl":"http://jira.codehaus.org/images/icons/priorities/blocker.png","name":"Blocker","id":"1"},"issuetype":{"self":"http://jira.codehaus.org/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"http://jira.codehaus.org/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"29190","self":"http://jira.codehaus.org/rest/api/2/issueLink/29190","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"http://jira.codehaus.org/rest/api/2/issueLinkType/10001"},"inwardIssue":{"id":"126583","key":"SUREFIRE-748","self":"http://jira.codehaus.org/rest/api/2/issue/126583","fields":{"summary":"Ensure plugin classloader is unloadable","status":{"self":"http://jira.codehaus.org/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"http://jira.codehaus.org/images/icons/statuses/closed.png","name":"Closed","id":"6"},"priority":{"self":"http://jira.codehaus.org/rest/api/2/priority/3","iconUrl":"http://jira.codehaus.org/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"http://jira.codehaus.org/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"http://jira.codehaus.org/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}}],"customfield_10163":"115689600","watches":{"self":"http://jira.codehaus.org/rest/api/2/issue/PLXUTILS-25/watchers","watchCount":1,"isWatching":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"subtasks":[],"status":{"self":"http://jira.codehaus.org/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"http://jira.codehaus.org/images/icons/statuses/closed.png","name":"Closed","id":"6"},"customfield_10090":null,"labels":[],"workratio":-1,"assignee":{"self":"http://jira.codehaus.org/rest/api/2/user?username=krosenvold","name":"krosenvold","emailAddress":"krosenvold@apache.org","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=krosenvold&avatarId=11127","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=krosenvold&avatarId=11127","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=krosenvold&avatarId=11127","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=krosenvold&avatarId=11127"},"displayName":"Kristian Rosenvold","active":true},"attachment":[{"self":"http://jira.codehaus.org/rest/api/2/attachment/42364","id":"42364","filename":"PLXUTILS-25.diff","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=igorfie","name":"igorfie","emailAddress":"igor@ifedorenko.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Igor Fedorenko","active":true},"created":"2009-06-02T12:31:15.584-0500","size":2255,"mimeType":"text/x-patch","content":"http://jira.codehaus.org/secure/attachment/42364/PLXUTILS-25.diff"}],"customfield_10221":null,"customfield_10220":null,"customfield_10200":null,"aggregatetimeestimate":null,"customfield_10190":null,"project":{"self":"http://jira.codehaus.org/rest/api/2/project/11432","id":"11432","key":"PLXUTILS","name":"Plexus Utils","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/projectavatar?size=xsmall&pid=11432&avatarId=10011","24x24":"http://jira.codehaus.org/secure/projectavatar?size=small&pid=11432&avatarId=10011","32x32":"http://jira.codehaus.org/secure/projectavatar?size=medium&pid=11432&avatarId=10011","48x48":"http://jira.codehaus.org/secure/projectavatar?pid=11432&avatarId=10011"},"projectCategory":{"self":"http://jira.codehaus.org/rest/api/2/projectCategory/10003","id":"10003","description":"various containers","name":"containers"}},"versions":[],"customfield_10170":null,"environment":null,"timeestimate":null,"customfield_10130":null,"aggregateprogress":{"progress":0,"total":0},"lastViewed":null,"components":[],"comment":{"startAt":0,"maxResults":5,"total":5,"comments":[{"self":"http://jira.codehaus.org/rest/api/2/issue/45651/comment/84101","id":"84101","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=mkleint","name":"mkleint","emailAddress":"mkleint@codehaus.org","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Milos Kleint","active":true},"body":"Checking the Ant's Execute class reveals that ant uses the same/similar strategy.  It however removes the shutdown hook if all the processes exited normally. If done in plexus-utils as well it should cater for 99.9 percent cases of possible failure in embedders as well.\r\n","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=mkleint","name":"mkleint","emailAddress":"mkleint@codehaus.org","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Milos Kleint","active":true},"created":"2007-01-05T04:17:47.272-0600","updated":"2007-01-05T04:17:47.272-0600"},{"self":"http://jira.codehaus.org/rest/api/2/issue/45651/comment/93757","id":"93757","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=lacostej","name":"lacostej","emailAddress":"jerome.lacoste@gmail.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Jerome Lacoste","active":true},"body":"the bug is probably in Thread.start which shouldn't take the assumption to add the Thread to the group at that time...\r\n\r\n1 idea: load the CommandLineUtils class before embedding maven (as to force the thread group of the shutdown hook to be the one of the embedder)\r\n","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=lacostej","name":"lacostej","emailAddress":"jerome.lacoste@gmail.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Jerome Lacoste","active":true},"created":"2007-04-21T00:51:36.807-0500","updated":"2007-04-21T00:51:36.807-0500"},{"self":"http://jira.codehaus.org/rest/api/2/issue/45651/comment/93758","id":"93758","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=lacostej","name":"lacostej","emailAddress":"jerome.lacoste@gmail.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Jerome Lacoste","active":true},"body":"Another more robust/intuitive solution is to assign a System Thread group to the Thread created and specieid to addShutdownHook().\r\n\r\nMaybe doing something like :\r\n\r\n    static\r\n    {\r\n\r\nThreadGroup root = Thread.currentThread().getThreadGroup().getParent();\r\n    while (root.getParent() != null) {\r\n        root = root.getParent();\r\n    }\r\n\r\n        Runtime.getRuntime().addShutdownHook( new Thread( root, \"CommandlineUtil shutdown\" )\r\n        {\r\n   ....\r\n\r\n\r\n","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=lacostej","name":"lacostej","emailAddress":"jerome.lacoste@gmail.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Jerome Lacoste","active":true},"created":"2007-04-21T00:56:56.821-0500","updated":"2007-04-21T00:56:56.821-0500"},{"self":"http://jira.codehaus.org/rest/api/2/issue/45651/comment/179038","id":"179038","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=igorfie","name":"igorfie","emailAddress":"igor@ifedorenko.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Igor Fedorenko","active":true},"body":"I ran into this/related issue when running maven in a \"recyclable\" while setting up maven performance regression tests. Registered shutdown hook instances are holding entire maven classloader in memory, which results in \"OutOfMemoryError: PermGen spac\" exceptions.\r\n\r\nI think proper long-term solution would be to turn CommandLineUtils into a component, so it can be shutdown properly as part of container shutdown. Proposed short-term solution (attached), is to allow embedding application to explicitly remove shutdown hook, optionally running it.","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=igorfie","name":"igorfie","emailAddress":"igor@ifedorenko.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Igor Fedorenko","active":true},"created":"2009-06-02T12:31:15.594-0500","updated":"2009-06-02T12:31:15.594-0500"},{"self":"http://jira.codehaus.org/rest/api/2/issue/45651/comment/267160","id":"267160","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=krosenvold","name":"krosenvold","emailAddress":"krosenvold@apache.org","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=krosenvold&avatarId=11127","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=krosenvold&avatarId=11127","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=krosenvold&avatarId=11127","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=krosenvold&avatarId=11127"},"displayName":"Kristian Rosenvold","active":true},"body":"Fixed in dff209e5a1f7c1bb4a4de2a19582bbc2cb3c6f0c. Registered shutdown hook per-invocation.","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=krosenvold","name":"krosenvold","emailAddress":"krosenvold@apache.org","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=krosenvold&avatarId=11127","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=krosenvold&avatarId=11127","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=krosenvold&avatarId=11127","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=krosenvold&avatarId=11127"},"displayName":"Kristian Rosenvold","active":true},"created":"2011-05-16T12:33:54.159-0500","updated":"2011-05-16T12:33:54.159-0500"}]},"timeoriginalestimate":null,"aggregatetimespent":null}}