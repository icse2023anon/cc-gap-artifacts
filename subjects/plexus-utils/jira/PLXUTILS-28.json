{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"46873","self":"http://jira.codehaus.org/rest/api/latest/issue/46873","key":"PLXUTILS-28","fields":{"progress":{"progress":0,"total":0},"summary":"FileUtils.cleanDirectory() does not remove symbolic links","timetracking":{},"issuetype":{"self":"http://jira.codehaus.org/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"http://jira.codehaus.org/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"customfield_10110":{"self":"http://jira.codehaus.org/rest/api/2/customFieldOption/10040","value":"yes","id":"10040"},"votes":{"self":"http://jira.codehaus.org/rest/api/2/issue/PLXUTILS-28/votes","votes":6,"hasVoted":false},"resolution":{"self":"http://jira.codehaus.org/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"fixVersions":[{"self":"http://jira.codehaus.org/rest/api/2/version/14438","id":"14438","description":"","name":"1.5.6","archived":false,"released":true,"releaseDate":"2008-08-01"}],"resolutiondate":"2008-07-20T18:27:31.259-0500","customfield_10210":"2.0","timespent":null,"reporter":{"self":"http://jira.codehaus.org/rest/api/2/user?username=srp","name":"srp","emailAddress":"srp@ncsa.uiuc.edu","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Steve Pietrowicz","active":true},"aggregatetimeoriginalestimate":null,"customfield_10161":["bentmann(bentmann)","pamdirac(pamdirac)","srp(srp)"],"customfield_10160":null,"updated":"2008-09-03T14:56:49.448-0500","created":"2007-02-02T09:27:33.187-0600","description":"FileUtils.cleanDirectory() will not remove symbolic links if they are located in the directory that you're trying to delete.\n\nYou can test this by running this shell script:\n-----\n#!/bin/sh\nmkdir /tmp/test_clean\necho > /tmp/test_clean/1\necho > /tmp/test_clean/2\nln -s /tmp/test_clean/foo /tmp/test_clean/bar\n----------\n\nand compiling and running this test program:\n----\n{code:java}\nimport org.codehaus.plexus.util.FileUtils;\nimport java.io.*;\n\npublic class broken {\n\n        static public void main(String[] argv) {\n                try {\n                        File file = new File(argv[0]);\n                        FileUtils.cleanDirectory(file);\n                } catch (Exception e) {\n                        System.out.println(e);\n                }\n        }\n}\n{code}\n-------------------\n\nI looked around for a fix to for this, and found this page:  http://joust.kano.net/weblog/archives/000071.html\n\nwhich offers the following public domain code, with a slight modification by me to only clean the directory, not delete it.\n{code:java}\n     public static boolean cleanDirectory(File dir) {\n        // to see if this directory is actually a symbolic link to a directory,\n        // we want to get its canonical path - that is, we follow the link to\n        // the file it's actually linked to\n        File candir;\n        try {\n            candir = dir.getCanonicalFile();\n        } catch (IOException e) {\n            return false;\n        }\n\n        // a symbolic link has a different canonical path than its actual path,\n        // unless it's a link to itself\n        if (!candir.equals(dir.getAbsoluteFile())) {\n            // this file is a symbolic link, and there's no reason for us to\n            // follow it, because then we might be deleting something outside of\n            // the directory we were told to delete\n            return false;\n        }\n\n        // now we go through all of the files and subdirectories in the\n        // directory and delete them one by one\n        File[] files = candir.listFiles();\n        if (files != null) {\n            for (int i = 0; i < files.length; i++) {\n                File file = files[i];\n\n                // in case this directory is actually a symbolic link, or it's\n                // empty, we want to try to delete the link before we try\n                // anything\n                boolean deleted = file.delete();\n                if (!deleted) {\n                    // deleting the file failed, so maybe it's a non-empty\n                    // directory\n                    if (file.isDirectory()) {\n                        cleanDirectory(file);\n                        file.delete();\n                    }\n\n                    // otherwise, there's nothing else we can do\n                }\n            }\n        }\n\n        return true;\n    }\n{code}\n\nI wrote a test program that incorporates this method and tested it using the same shell script, and it works.\n\nI've uploaded the test programs and a shell script that creates additional links, directories and links to directories to try and be sure all test cases are covered.","priority":{"self":"http://jira.codehaus.org/rest/api/2/priority/3","iconUrl":"http://jira.codehaus.org/images/icons/priorities/major.png","name":"Major","id":"3"},"duedate":null,"issuelinks":[{"id":"20424","self":"http://jira.codehaus.org/rest/api/2/issueLink/20424","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"http://jira.codehaus.org/rest/api/2/issueLinkType/10001"},"inwardIssue":{"id":"60741","key":"MCLEAN-28","self":"http://jira.codehaus.org/rest/api/2/issue/60741","fields":{"summary":"maven-clean-plugin doesn't delete directories with symlinks in them","status":{"self":"http://jira.codehaus.org/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"http://jira.codehaus.org/images/icons/statuses/closed.png","name":"Closed","id":"6"},"priority":{"self":"http://jira.codehaus.org/rest/api/2/priority/3","iconUrl":"http://jira.codehaus.org/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"http://jira.codehaus.org/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"http://jira.codehaus.org/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"20422","self":"http://jira.codehaus.org/rest/api/2/issueLink/20422","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"http://jira.codehaus.org/rest/api/2/issueLinkType/10001"},"inwardIssue":{"id":"73105","key":"MSHARED-58","self":"http://jira.codehaus.org/rest/api/2/issue/73105","fields":{"summary":"FileSetManager.delete() fails to delete dangling symlinks","status":{"self":"http://jira.codehaus.org/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"http://jira.codehaus.org/images/icons/statuses/closed.png","name":"Closed","id":"6"},"priority":{"self":"http://jira.codehaus.org/rest/api/2/priority/3","iconUrl":"http://jira.codehaus.org/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"http://jira.codehaus.org/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"http://jira.codehaus.org/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_10163":"204681600","watches":{"self":"http://jira.codehaus.org/rest/api/2/issue/PLXUTILS-28/watchers","watchCount":3,"isWatching":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"subtasks":[],"status":{"self":"http://jira.codehaus.org/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"http://jira.codehaus.org/images/icons/statuses/closed.png","name":"Closed","id":"6"},"customfield_10090":null,"labels":[],"workratio":-1,"assignee":{"self":"http://jira.codehaus.org/rest/api/2/user?username=bentmann","name":"bentmann","emailAddress":"benjamin.bentmann@udo.edu","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Benjamin Bentmann","active":true},"attachment":[{"self":"http://jira.codehaus.org/rest/api/2/attachment/25544","id":"25544","filename":"cleanDirectory_fix.tar.gz","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=srp","name":"srp","emailAddress":"srp@ncsa.uiuc.edu","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Steve Pietrowicz","active":true},"created":"2007-02-02T09:27:33.245-0600","size":1411,"mimeType":"application/x-gzip","content":"http://jira.codehaus.org/secure/attachment/25544/cleanDirectory_fix.tar.gz"},{"self":"http://jira.codehaus.org/rest/api/2/attachment/27038","id":"27038","filename":"r6344.patch","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=pamdirac","name":"pamdirac","emailAddress":"john@mcnair.org","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"John McNair","active":true},"created":"2007-04-26T15:41:26.054-0500","size":2445,"mimeType":"text/x-patch","content":"http://jira.codehaus.org/secure/attachment/27038/r6344.patch"}],"customfield_10221":null,"customfield_10220":null,"customfield_10200":null,"aggregatetimeestimate":null,"customfield_10190":null,"project":{"self":"http://jira.codehaus.org/rest/api/2/project/11432","id":"11432","key":"PLXUTILS","name":"Plexus Utils","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/projectavatar?size=xsmall&pid=11432&avatarId=10011","24x24":"http://jira.codehaus.org/secure/projectavatar?size=small&pid=11432&avatarId=10011","32x32":"http://jira.codehaus.org/secure/projectavatar?size=medium&pid=11432&avatarId=10011","48x48":"http://jira.codehaus.org/secure/projectavatar?pid=11432&avatarId=10011"},"projectCategory":{"self":"http://jira.codehaus.org/rest/api/2/projectCategory/10003","id":"10003","description":"various containers","name":"containers"}},"versions":[],"customfield_10170":null,"environment":"Tested on Linux, Fedora Core 5","timeestimate":null,"customfield_10130":null,"aggregateprogress":{"progress":0,"total":0},"lastViewed":null,"components":[],"comment":{"startAt":0,"maxResults":4,"total":4,"comments":[{"self":"http://jira.codehaus.org/rest/api/2/issue/46873/comment/86672","id":"86672","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=srp","name":"srp","emailAddress":"srp@ncsa.uiuc.edu","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Steve Pietrowicz","active":true},"body":"Sorry for the formatting on the code.   Download the tarball to see the code.","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=srp","name":"srp","emailAddress":"srp@ncsa.uiuc.edu","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Steve Pietrowicz","active":true},"created":"2007-02-02T13:07:36.642-0600","updated":"2007-02-02T13:07:36.642-0600"},{"self":"http://jira.codehaus.org/rest/api/2/issue/46873/comment/94277","id":"94277","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=pamdirac","name":"pamdirac","emailAddress":"john@mcnair.org","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"John McNair","active":true},"body":"I fixed this an alternate way.  The real problem is that dangling symlinks don't exist according to File.exists(), so forceDelete() skips over them.  This can be a problem in deleteDirectory() even if you have valid symlinks because you don't necessarily know that a given symlink will be deleted before its target.\r\n\r\nThe solution is just to make forceDelete() a little more forceful, i.e., try to delete even if the file does not exist and ignore failure for that one case only.\r\n\r\nI also added 3 unit tests to verify:\r\n- can delete symlink->file\r\n- can delete symlink->directory\r\n- can delete symlink->nothing at all (this was what was broken)\r\n\r\nThe unit tests only run on Linux (and do nothing elsewhere).  I had to use Runtime to execute /bin/ls.  That obviously doesn't work on Windows and likely several other Java hosts.  Would you rather determine the execution set via inclusion or excusion?\r\n\r\nI have attached the output of 'svn diff' where my working copy is r6344.\r\n\r\nThis bug bites people using Continuum that have symlinks in their build directories (like me).  Continuum explodes, and you have to manually clean up.  So it would be cool if this could be fixed.\r\n\r\nThanks.","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=pamdirac","name":"pamdirac","emailAddress":"john@mcnair.org","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"John McNair","active":true},"created":"2007-04-26T15:41:26.058-0500","updated":"2007-04-26T15:41:26.058-0500"},{"self":"http://jira.codehaus.org/rest/api/2/issue/46873/comment/142541","id":"142541","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=bentmann","name":"bentmann","emailAddress":"benjamin.bentmann@udo.edu","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Benjamin Bentmann","active":true},"body":"Related to [IO-147|https://issues.apache.org/jira/browse/IO-147].","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=bentmann","name":"bentmann","emailAddress":"benjamin.bentmann@udo.edu","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Benjamin Bentmann","active":true},"created":"2008-07-20T17:00:01.960-0500","updated":"2008-07-20T17:00:01.960-0500"},{"self":"http://jira.codehaus.org/rest/api/2/issue/46873/comment/142547","id":"142547","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=bentmann","name":"bentmann","emailAddress":"benjamin.bentmann@udo.edu","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Benjamin Bentmann","active":true},"body":"Applied John's patch in [r7530|http://fisheye.codehaus.org/changelog/plexus/?cs=7530], thanks!","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=bentmann","name":"bentmann","emailAddress":"benjamin.bentmann@udo.edu","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Benjamin Bentmann","active":true},"created":"2008-07-20T18:27:31.239-0500","updated":"2008-07-20T18:27:31.239-0500"}]},"timeoriginalestimate":null,"aggregatetimespent":null}}